#!/usr/bin/env node

// Post-checkout hook - creates checkpoint after checkout
// Also detects failures and warns user
const path = require('path');
const defaultRoot = path.join(__dirname, '..', '..');
const configuredRoot = process.env.EASEGIT_PACKAGE_ROOT || "__EASEGIT_PACKAGE_ROOT__";
const packageRoot = configuredRoot.startsWith('__EASEGIT_PACKAGE_ROOT__') ? defaultRoot : configuredRoot;
const { createCheckpoint } = require(path.join(packageRoot, 'dist', 'snapshot', 'create'));
const { hasMergeConflicts, isDetachedHead, isDirty } = require(path.join(packageRoot, 'dist', 'git', 'plumbing'));

// Create checkpoint for the new state
createCheckpoint('checkout');

// Check for problems after checkout
try {
  const hasConflicts = hasMergeConflicts();
  const detached = isDetachedHead();
  const dirty = isDirty();
  
  if (hasConflicts || (detached && dirty)) {
    console.error('âš  EaseGit: last Git operation damaged your working state.');
    console.error('Run `easegit undo` to restore the last safe checkpoint.');
  }
} catch {
  // Silent fail
}
